name: E2E Tests (Detox)

on:
  pull_request:
    branches: [beta]
    types: [opened, synchronize, reopened]

jobs:
  e2e-ios:
    runs-on: macos-14 # Use macos-14 for more consistent Xcode versions
    continue-on-error: true # Don't block PRs if tests fail
    timeout-minutes: 45 # Prevent hanging builds
    env:
      SENTRY_DSN: ${{secrets.SENTRY_DSN}}
      ENVIROINMENT: ${{secrets.ENVIROINMENT}}
      INTERCOM_APP_KEY: ${{secrets.INTERCOM_APP_KEY}}
      WALLET_CONNECT_PROJECTID: ${{secrets.WALLET_CONNECT_PROJECTID}}
      HELIUS_API_KEY: ${{ secrets.HELIUS_API_KEY }}
      WEB3_AUTH_CLIENT_ID: ${{ secrets.WEB3_AUTH_CLIENT_ID }}
      CI: true
      NODE_ENV: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Configure npm
        run: |
          echo "@cypherd-io:registry=https://npm.pkg.github.com/" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${NPM_TOKEN}" >> .npmrc
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create .env file
        run: |
          echo "WALLET_CONNECT_PROJECTID=${{ secrets.WALLET_CONNECT_PROJECTID }}" >> .env
          echo "INTERCOM_APP_KEY=${{ secrets.INTERCOM_APP_KEY }}" >> .env
          echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" >> .env
          echo "ENVIROINMENT=${{ secrets.ENVIROINMENT }}" >> .env
          echo "HELIUS_API_KEY=${{ secrets.HELIUS_API_KEY }}" >> .env
          echo "WEB3_AUTH_CLIENT_ID=${{ secrets.WEB3_AUTH_CLIENT_ID }}" >> .env

      - name: Check Xcode version and available simulators
        run: |
          echo "=== Xcode Information ==="
          xcodebuild -version
          echo ""
          echo "=== Available iOS Simulators ==="
          xcrun simctl list devices iOS available --json | jq -r '.devices | to_entries[] | .key as $os | .value[] | select(.isAvailable == true) | "\($os): \(.name) (\(.udid))"'
          echo ""
          echo "=== SDK Information ==="
          xcodebuild -showsdks | grep iOS

      - name: Clear CocoaPods cache
        run: |
          echo "=== Clearing CocoaPods cache ==="
          pod cache clean --all || true
          cd ios
          rm -f Podfile.lock || true

      - name: Install CocoaPods dependencies
        run: |
          echo "=== Installing CocoaPods dependencies ==="
          cd ios
          pod install --repo-update --verbose

      - name: Verify deployment targets
        run: |
          echo "=== Verifying iOS deployment targets ==="
          cd ios
          # Check if any pods still have deployment target < 15.0
          PODS_WITH_OLD_TARGET=$(grep -r "IPHONEOS_DEPLOYMENT_TARGET = 1[0-4]\." Pods/Pods.xcodeproj/project.pbxproj || echo "None found")
          if [ "$PODS_WITH_OLD_TARGET" != "None found" ]; then
            echo "âš ï¸  Found pods with old deployment targets:"
            echo "$PODS_WITH_OLD_TARGET"
          else
            echo "âœ… All pods have deployment target >= 15.0"
          fi

      - name: Install Detox CLI
        run: npm install -g detox-cli

      - name: Install applesimutils
        run: |
          brew tap wix/brew
          brew install applesimutils

      - name: Setup iOS Simulator
        run: |
          echo "=== Setting up iOS Simulator ==="

          # Find the best available iOS simulator
          # First try to find iPhone 15 with any iOS 17.x version
          IPHONE15_SIMULATOR=$(xcrun simctl list devices iPhone available | grep "iPhone 15" | head -1 | sed 's/^[[:space:]]*//' || echo "")

          if [ -n "$IPHONE15_SIMULATOR" ]; then
            echo "Found existing iPhone 15 simulator: $IPHONE15_SIMULATOR"
          else
            echo "No iPhone 15 simulator found, checking for other iPhone models..."
            # Fallback to iPhone 14 or iPhone 13
            IPHONE_SIMULATOR=$(xcrun simctl list devices iPhone available | grep -E "iPhone (14|13)" | head -1 | sed 's/^[[:space:]]*//' || echo "")
            
            if [ -n "$IPHONE_SIMULATOR" ]; then
              echo "Found alternative iPhone simulator: $IPHONE_SIMULATOR"
              # Update Detox config to use this simulator
              DEVICE_NAME=$(echo "$IPHONE_SIMULATOR" | sed 's/ (.*//')
              echo "Updating Detox config to use device: $DEVICE_NAME"
              
              # Create a temporary detox config
              sed "s/iPhone 15/$DEVICE_NAME/g" .detoxrc.js > .detoxrc.temp.js
              mv .detoxrc.temp.js .detoxrc.js
            else
              echo "Creating iPhone 15 simulator..."
              # Find available iOS runtime
              RUNTIME=$(xcrun simctl list runtimes | grep "iOS" | grep -E "17\.|16\." | head -1 | sed 's/.*iOS \([0-9\.]*\).*/\1/')
              if [ -n "$RUNTIME" ]; then
                echo "Using iOS runtime: $RUNTIME"
                xcrun simctl create "iPhone 15" "iPhone 15" "iOS$RUNTIME" || true
              fi
            fi
          fi

          echo ""
          echo "=== Final simulator list ==="
          xcrun simctl list devices available

      - name: Create e2e environment file
        run: |
          echo "TEST_SEED_PHRASE=${{ secrets.E2E_TEST_SEED_PHRASE }}" > e2e/.env.test
        env:
          E2E_TEST_SEED_PHRASE: ${{ secrets.E2E_TEST_SEED_PHRASE }}

      - name: Build iOS app for testing
        run: |
          echo "=== Starting iOS Build ==="
          echo "Current directory: $(pwd)"
          echo "Available iOS simulators:"
          xcrun simctl list devices iOS --json
          echo "=== Building with Detox ==="
          detox build --configuration ios.sim.debug --verbose
        timeout-minutes: 20

      - name: Run E2E Tests - iOS
        run: npm run e2e:test:ios
        continue-on-error: true

      - name: Clean up .env file
        if: always()
        run: rm -f .env

      - name: Upload iOS test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-ios-results
          path: |
            e2e/artifacts/
            detox_*.log
            ios/build/Build/Logs/
          retention-days: 7

      - name: Report E2E Test Results
        if: always()
        run: |
          echo "## E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **iOS E2E Tests Completed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following test suites were executed:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ App Launch Test" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘‹ Onboarding Flow" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“² Import Wallet Flow" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’³ Load Card Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** E2E tests are informational and do not block PR merging." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Check the job logs above for detailed test results._" >> $GITHUB_STEP_SUMMARY
